package verifier

import (
	"encoding/base64"
	"testing"

	"github.com/trustbloc/kms-go/doc/jose"

	"github.com/fiware/VCVerifier/logging"
	"github.com/stretchr/testify/assert"
)

type mockExternalValidator struct {
	signatureValid bool
}

const SameIssuer = "did:elsi:VATDE_1234567"
const OtherIssuer = "did:elsi:VATDE_999"
const AnyHeaderAndPayload = "ZXlKaGJHY2lPaUpTVXpJMU5pSXNJbU4wZVNJNkltcHpiMjRpTENKcmFXUWlPaUpOU1VkQlRVZHBhMXBxUW10TlVYTjNRMUZaUkZaUlVVZEZkMHBGVWxSRlVFMUJNRWRCTVZWRlEwRjNSMUZ0Vm5saVIyeDFUVkpKZDBWQldVUldVVkZMUkVGc1IxTldaRUpWYTFWblVUQkZlRVZxUVZGQ1owNVdRa0ZOVFVOVldrcFdNRVpUVWxNeFJGRlVSV05OUW05SFExTnhSMU5KWWpORVVVVktRVkpaVGxreVJrRmFiV3d6V1ZoS2JFeHRPWGxhZDBsVlNXdHJXR0p6VEhOMGFVeG1aV1Z0YTNZeUsySlFVRVF5VlRSclBTSXNJbmcxZENOVE1qVTJJam9pTlRWM1EwRnNUbTV4TURNMmVFaHNSakppV2poWFp6WlJjVXRPUWpaNGNEWkJVR3RUYURKYWVXUXdUU0lzSW5nMVl5STZXeUpOU1VsSVQycERRMEpUUzJkQmQwbENRV2RKVlVscmExaGljMHh6ZEdsTVptVmxiV3QyTWl0aVVGQkVNbFUwYTNkRVVWbEtTMjlhU1doMlkwNUJVVVZNUWxGQmQxcEVSVXhOUVd0SFFURlZSVUpvVFVOU1JWVjRSSHBCVGtKblRsWkNRV2ROUW10S2JHTnRlSEJpYWtWVFRVSkJSMEV4VlVWRFozZEtVbXRzV0ZGV1NrWkpSVTVDVFZKSmQwVkJXVVJXVVZGRVJFRnNSMU5XWkVKVmExVjBVVEJGZUVoRVFXRkNaMnR4YUd0cFJ6bDNNRUpEVVVWWFJGZE9hRkZIV25Ca01rWjVXbE0xZG1OdFkzZElhR05PVFdwUmQwNXFSWGxOUkdOM1RsUkJNMWRvWTA1TmFtdDNUbXBGZUUxRVkzZE9WRUV6VjJwRFFuQnFSVXhOUVd0SFFURlZSVUpvVFVOU1JWVjRSSHBCVGtKblRsWkNRV2ROUW10S2JHTnRlSEJpYWtWUVRVRXdSMEV4VlVWQ2QzZEhVVzFXZVdKSGJIVk5VbTkzUjBGWlJGWlJVVXRFUWtaSFUxWmtRbFZyVldkU2JUa3hZbTFTYUdSSGJIWmlha1ZWVFVKSlIwRXhWVVZCZDNkTVVtdHNXRkZXU2taTVZsSnNZek5SZUVocVFXTkNaMnR4YUd0cFJ6bDNNRUpEVVVWWFJETlNiR016VWtGYWJXd3pXVmhLYkV4dE9YbGFla1ZNVFVGclIwRXhWVVZDVWsxRFRVUk5lRVpxUVZWQ1owNVdRa2RGVFVSV1drSldSVkpHVEZSRmVVMTZVVEZPYW1OM1oyZEphVTFCTUVkRFUzRkhVMGxpTTBSUlJVSkJVVlZCUVRSSlEwUjNRWGRuWjBsTFFXOUpRMEZSUkVGS1pUVkJhbEJWYlU1M1ozVlZWblZKTVZZeVRTdFljazV0Um1NM05WQlNNSFJzVUV3NWJFUkxSMkZKTkRaVlRYTk1Obk5wWVZGVFZURlpWMVVyVURGbFRYUXpWSEowZFhoS1ZrNXdUbVZCUm1rNVJXcExaM1ppVldoWFUweE9SemhTVld0SVptdE5RbEp0VmpkQlVVazFlRWhYUzFWWVJ6TnJlVTVLUlZacGJWbFhSa0Z0YWxaWWF5dHhSRU5tV2tKTlVpODVNamRJZDNwWWRtRmpaUzl6VFdsUEsza3pkRXB1TUhReU4wOW5kRlJuWTJndk5WaHlSWFprU2tWRU1uVnZLMnAzWTJobGNWVkpVV3BSUW5SaWFYbGpXV0pTTVVkalJqVnVVMHRZZFU5alVrdEVaMWN5ZEZBdlMwTlNiakZNVlc5cksyWmxVbWszY0hoWFR6TnZRV3hwZEVwblZTdEZWR1pXTVhBNGNHSm5UWFowVFdkM1FrTnhVbE42Y2xkTWFHaFNkRzFqVTBkM1JrRmxkVFpPWnpCa01pc3hjWGRuTUhkMVJIWklaRmMyZUdwV2IyNXpMMFowTmpZeVEyeGpWa1puZEhrdlpuZFhlaXRDTXpGVWRsbFRjRFlyTjFsbGN5dHhkM05oYjBoMUsxcG9lbmhaYWpWa2FWWXpjREZwZVhSVWFYZFNVa2QwYnpSNGNEZG1WRkJsUldadFpFcHJVVXhpZEVOM2NYcE5lVlF3VFRaWlFubEpPQ3Q0UVVSV05uaFJTR2x1VFhORGR6aFdhSEExT1ZoQk1UUjRNa3d4TkVocldHZzRPWGxaTUcxeFZ6TkNlRTR6SzAxVGFtbEtWRE5IVWxwYVRrRkVTalpHU3pZNE1ubEdXbXh6UmtOcVpURnpiM1paZGxsSVZHSjBMMnRxZWtGcFIzRlNiRzg1YkhKeFdESlNTRXczVEcxRlVXaElORFpGY0ROWlpVb3JaMEpqT0ZSalNVRTBkaXQ2VFdKU2RYSm1PVk5PVHpRdmFWUnBPRTQzWmpaTVNFZG9aVGxFYlZoWE1HWXhUMDlzY2xadWR6VlhTMDA1Y3pCMUwwZHlha0U0ZGtoRUwwOVphQzlpUjBGM1ZuWmxMMGRNYm5JeWVETnJkRVpOVjJwdVMxSlFhbFJsV1ZwSmNuYzFRMFk0WmpWSlVuSmxkSGgyYUhGVk9GQm9kM2RSU1VSQlVVRkNielJKUW01NlEwTkJXbk4zWjFvMFIwTkRjMGRCVVZWR1FuZEZSRUpKUjFKTlNVZFBUVUZuUjBKblVVRnFhMWxDUVZSQk5FSm5XVVZCU1RWSFFWRlZkMHhxUVhOR2FVWnZaRWhTZDJONmIzWk1NbFkwV1ZjeGQySkhWWFZpTTBwdVRETkNjbUZYVW5Cak1rNXpZak5PTVdOdFZWUkNNbFkwV1ZjeGQySkhWWGRKVVZsSFFrRkRRbTFEWTBOTlFtTk5SRVpPZG1KWFZXZGtSMVo2WkVOQ1JGRlJkMGhYUm1kMFVrVmFWRkZVUVd4Q1oxbEZRVWsxUjBGUldYZEhkMWxJUWtGRFQxSm5SVWRCVVZsSVFrRkRUMUpuUlVkQloxbElRa0ZEVDFKblJVZEJla0ZLUW1kT1ZraFNUVVZCYWtGQlRVSkZSME5YUTBkVFFVZEhLMFZKUWtGUlVVVkJkMGxHYjBSQmVrSm5iR2RvYTJkQ2FIWm9RMEZSTUVWS2FGbHJWRE5DYkdKc1RsUlVRMEpJV2xjMWJHTnRSakJhVjFGblVUSjRjRnBYTlRCSlJVNXNZMjVTY0ZwdGJHcFpXRkpzVFVJd1IwRXhWV1JFWjFGWFFrSlJTRUUyYzFoUWQxUmhhM05STlZCdmNtZ3paRlIwVUdSc1ZHTnFRV1pDWjA1V1NGTk5SVWRFUVZkblFsUndWVkZzVjFwQkswWlVUWE5pWVZJeFdHVlNSbmhMVFhaVlUwUkJUMEpuVGxaSVVUaENRV1k0UlVKQlRVTkNaVUYzU0ZGWlJGWlNNR3hDUWxsM1JrRlpTVXQzV1VKQ1VWVklRWGRKUjBORGMwZEJVVlZHUW5kTlJVMUVXVWRCTVZWa1NIZFJkazFETUhkTE5rRndiME5sUjBwWGFEQmtTRUUyVEhrNWMySXpVbk5QYWsxM1RVUkJkbUZYTlRCYVdFcDBXbGRTY0ZsWVVteE1iVTU1WWtNMWQxcFhNSGRFVVZsS1MyOWFTV2gyWTA1QlVVVk1RbEZCUkdkblNVSkJSRFZxZFZaTmFGTjFTQ3R6TnpaWFR6bHNaRkprWXpKQmVscE5iMkpaTDJwV1kwNDFlV1I0UmpKcE9USlNRV1pRZFRRNWEyRlNielJaWmpJM01DdG9OazlYTUdaNU1WcEZhMWQwVEhsVlZFRjFZMDlVVVVKQ2MybFdaVkI0UVU1Skt5OWxUekY1U0c1WVRpOTNZVll2THl0bU9XSlBTVXhTVVhwRE9HdDJTa0pYTDJKUlZHcHBSRWxyU3pKRlptOVJlVlJXWVU1dmVWSXlPRWw1Ympob1VHOVBUbmRDVldOcU9IQm5abTVIYVU1dmEySk5lVzVKVDBoNkswSTFOWEJLTDBsTVNDc3ZTV0ZXTWxaeFFtczROMkpzZDBkRWQxQlJlbFE0Y1ZCU1VDdDZaa1ZQYW1aS2RrZ3pPRWcwV1d4eVFqZHRjemN6TDNSeWJpODRiWGhGSzFaME1IQnBaR1J0U0hoR1RHWjJNMkZ6Y2xaclNXZHRhRUYzWlhsbU5XcFRhelF4ZUZWeU9WZEljbkpCVDJsclFrSkplazVZVUROMFFYcEROemRxVTNwa01tbE5SM1JPVVRkVE5VVm9jMFJET1RCUmREbHRZMEkyZDJobVlYcHJaSEk1YUUxWldYbHBjbE5RSzI5dmIyeEJaaTgzWXpCcWVsbFJibFZtZFc1dlowaE5SblJWTjA1RlNFTktSSHB5YjNRclkxTjRSV2hHWmxWRVRYcENOamM0ZWpkMGQyaFZNVm8wYm5aNGNDdHVTMGx0VG5wd01YQXlSMlFyVDJoNWF6TlVhRWRxUWxoVFIxRTJRbWxDZEhGS1VsVlhSWGh4YTFZd1FYZGlPVGRvVmpaWldTOTFlV05JYUZadlltMWFZbXN6YmxKcWRUTnNTVTFhV0hvcmVrUXhiVXBUYmxOV1NFbEVSREpQYmpkc01qZHhiblJLVFc1RFJGSlplamhqTTJ4NFVVUkZVMWwzU0VoUVIzcHlSVEJaZEZVMlNXOVpUV1YyWkRZME5VcEJMekpPVkRNeFZHeHdXREoyUzBzdmIwZFpiM1pZTlRsc1NYcGhiSFJMWVhCNVJta3dOWE5rVjNaVVNuUldhWEpsYlhkMWJHbHNSMVJzYkRoUllYZzRSVVpDVlZjdmJWcDJUMVZqWlZkUGJtMW1VRkpUZVZBM09WWmxPRlZET1hsM2JUZDZUMU0yV1VwcVdEY2lMQ0pOU1VsR2VVUkRRMEUzUTJkQmQwbENRV2RKUWtGVVFVNUNaMnR4YUd0cFJ6bDNNRUpCVVhOR1FVUkRRbWRxUlV4TlFXdEhRVEZWUlVKb1RVTlNSVlY0UkhwQlRrSm5UbFpDUVdkTlFtdEtiR050ZUhCaWFrVlFUVUV3UjBFeFZVVkNkM2RIVVcxV2VXSkhiSFZOVWtsM1JVRlpSRlpSVVV0RVFXeEhVMVprUWxWclZXZFJNRVY0UldwQlVVSm5UbFpDUVUxTlExVmFTbFl3UmxOU1V6RkVVVlJGWTAxQ2IwZERVM0ZIVTBsaU0wUlJSVXBCVWxsT1dUSkdRVnB0YkROWldFcHNURzA1ZVZwNlJVeE5RV3RIUVRGVlJVSlNUVU5OUkVWM1NHaGpUazFxVVhkT2FrVjVUVVJqZDA1VVFUSlhhR05PVFhwRmQwOVVSVEJOUkdOM1RsUkJNbGRxUW10TlVYTjNRMUZaUkZaUlVVZEZkMHBGVWxSRlVFMUJNRWRCTVZWRlEwRjNSMUZ0Vm5saVIyeDFUVkpKZDBWQldVUldVVkZMUkVGc1IxTldaRUpWYTFWblVUQkZlRVZxUVZGQ1owNVdRa0ZOVFVOVldrcFdNRVpUVWxNeFJGRlVSV05OUW05SFExTnhSMU5KWWpORVVVVktRVkpaVGxreVJrRmFiV3d6V1ZoS2JFeHRPWGxhZWtORFFXbEpkMFJSV1VwTGIxcEphSFpqVGtGUlJVSkNVVUZFWjJkSlVFRkVRME5CWjI5RFoyZEpRa0ZMUjNCVWVVeG1XVlZ6YWpoWGF6Vk1lRUk1Vkc1MU9HTnpRVFpqVlVrNVdHRjZTa0ZRWWpkVllUbFRibUZETW0xalZrUjNPVzlCU0hsUlJsZHpVMVEyVGxscFMzSnpabWxHYUcxMU9WVkhNalZEZG5VMGJuSmxNREJVTUhBNU1EQm9ZVGhuTlhCTWNWUkpSR1p4VGtsd1lqSXZNamwxVnl0MVpsTXZhMWhEVW1zMVdIaEtXVGhCYXl0RGQwbHBUVzAzZFVOV1dYZG1jbWR1V1N0clNsVTRUbmhzVEZadlpIcGliR3RqVldnMVVtVjRhRmhpTW5OMVdDOW9ZMUJWUVZodGN6SnlWVkJFTUVwNk1UWTFNRUZHYVhWbmFWZE1iVEpSUW5VeFZYWXhMekppWkhwdldVRlZkVEJITm0xTlNXcG5WMU52VGpOdVNIQlBRM2xZU2xOVE1sUTFXbWxKUW5jMVNuWkJjVzR4TW0xMksxbzNVbkZwTUc4dllqSllhbTg0TUdkSk9IWkZZVlp2UXpsRlkycFlkVmROYzBoSldqWk5XWGRUYTFOS2IyZE9ObGhEY1VsQldqTmpZVWxSVTBaRE9GbFRPVk16ZWxwTVZrbFdZVUpaVkM5UWFXTlhOekZQVGl0R1NXNUhjR2RQZWtWeWQzZzRNR04wTWl0NlEwaHFkamRYTkZKc2J5dENia1JyVEdZNU1qTmhObTl3YVRWWlVVSjVVa2xLUTI0d1RXWnNaVWhHT1RGcVNXWnlTMHhIUVhaMmRIWk9hamRuV1VwWmVHOHlhWGQ0ZGxRelR5OHhNMDFZYmpnd1JHeFNjRE5EUjFSUGJHWmpjakZsYTA5blR6UkVWamd6UWtwUU5rOXFhWFowUmxkU2RYbHpiRUZyTlhwSFFXZzJZVmxTU25WS2JXMHJSVEp1ZFdKSVpFUmpTbWRoZWxGeWRUbEJWbXRYYkhGMGJXOTVXR1k1ZGpWcE4wNWpjRzVNYVdkeE5IWXdhazVVYUZSWFdGQlJXVGhyUkRRNVVVZHJLMkZRWjI1NGQzcHdSa0ZTYWtoRWRrSmpWR0ZsV0dkU2RsRkZXVkEzYmtwdFYwbENRWGxOUXpJNVEweEtPVTB4WWpGU1RYVkNRM0IyVmxCMlQyZzJUakZaWjJGSGVETnJOMmhoVEVrNGNtODJkVFpQTVVZeVpYcFlPVWRyV0dKR056bFpOVUZuVFVKQlFVZHFXbXBDYTAxQ01FZEJNVlZrUkdkUlYwSkNWSEJWVVd4WFdrRXJSbFJOYzJKaFVqRllaVkpHZUV0TmRsVlRSRUZtUW1kT1ZraFRUVVZIUkVGWFowSlNORWhoVTA1cVJHVlNXbWMzV1ZCcVEyRTVjVFpoVDJoRlJXZFVRVk5DWjA1V1NGSk5Ra0ZtT0VWRFJFRkhRVkZJTDBGblJVRk5RVFJIUVRGVlpFUjNSVUl2ZDFGRlFYZEpRbWhxUVU1Q1oydHhhR3RwUnpsM01FSkJVWE5HUVVGUFEwRm5SVUZMY1VOd2FpOHJURVpEVERGU0swZDNTazFxV1ZwRmVERnlVbmR1VDBRelkycFZWbGROUjFWM1pXZEtjbFY2ZEdOeVEwSnRTbkY1UTJaVlREZHBaVFEwYTJ3eE5FaEVNa3R2VEN0Q2FIWlhiVGRMWm5NMk1EUllXVWxDWkdsUFpWbHBZVUo1WW1wcGMxSmFVRk5EWXpkcGRqbDVjSFZUZW1KemJtSlZlR3hIUlhaRWVqTmxjelJpVm1ST1FuTnlRVTlHTW1oS1pteGhhRTVyYkVwMVZWVmhjMWxPVGtjNWFEbENaamQ1ZWpoNmIwd3dURk4wY1RJNE5IWjVkM1ZoU1RCVlFXOVRkbmd2U0Vkd2FqSnlWbTR6ZEdST1pGWmxiRVJuZFhaRmEwTnhaVUZsYW1nNFdHMVVZbFI0TmpKUVNrUTFNelIwYzFZMFVWaDFWSHBVV1doTmJtcDNlbFo1WjAwek9FYzNTamhPVjI5TGN6UlhPSGhIVW1RMmRtYzVUMnBZTUU4clFuazFjVFJZWkhsNWJHeGhSVTQ1ZG01alRHSnRSVFZpVUd0cFZsUk5aMHBxUnpKamVHSjVTUzl5VUVaaWRFMVBLMjUwVjJ0bFJETlBNR2RXU1ZKUlZpOVNLMmx1YURKR2VVSm1SRU5qVTBaNUwwdFJVV3MzUkRZNWNVOWhPVEpUTW1OcVJGYzJZM2h0Ym1GdVFXUmthbGhPTUVKSE0ySXZiakowU0M5NVFubFVVMHAxU0RkNVVFTm9kV1IxY1hwVmJtRkZUa2xRYjAxRmEwODVhbEZyWmtaVVVrVlZNbHBZUzBKcFpGWXdRMjFvUWpWbldHZDJNR1p2Y2pkck4xZHljWEl5YlU5TWFVWkdRME5SUkdsWFJEY3lTRWRNTW1SMFJuWlVlV2t4WkRFdkszb3JOVkJzYnpCU1l6ZzViRzFyU1ZvelZUTjBXVU5sYlc0MWJHOVhNM2RHZGtJeldIWnNUM2xOWjNCWVFVVXZja2xaWXpSelVpdENWRFJNSzJFNEsybFpSMmRFUTFWUldWUndkMjF6WlhCclVVWmlUMFpCUkVwa01HYzRhbHBsVVZCdWVIcFBkSGRWYlVzdlNWWk9hMmhQUWxKUkwwZGlVVlU0U0U1aE9UWmlOVnByVEVZeWFqZzJPRU5qVGtWNlIySnFUR1pCZWxwd2NXNUNZVGgwU2tRMVRVMDViejBpTENKTlNVbEdNVVJEUTBFM2VXZEJkMGxDUVdkSlFrRlVRVTVDWjJ0eGFHdHBSemwzTUVKQlVYTkdRVVJEUW1kcVJVeE5RV3RIUVRGVlJVSm9UVU5TUlZWNFJIcEJUa0puVGxaQ1FXZE5RbXRLYkdOdGVIQmlha1ZRVFVFd1IwRXhWVVZDZDNkSFVXMVdlV0pIYkhWTlVrbDNSVUZaUkZaUlVVdEVRV3hIVTFaa1FsVnJWV2RSTUVWNFJXcEJVVUpuVGxaQ1FVMU5RMVZhU2xZd1JsTlNVekZFVVZSRlkwMUNiMGREVTNGSFUwbGlNMFJSUlVwQlVsbE9XVEpHUVZwdGJETlpXRXBzVEcwNWVWcDZSVXhOUVd0SFFURlZSVUpTVFVOTlJFVjNTR2hqVGsxcVVYZE9ha1Y1VFVSamQwNVVRVEZYYUdOT1RYcFJkMDVxUlhkTlJHTjNUbFJCTVZkcVEwSm5ha1ZNVFVGclIwRXhWVVZDYUUxRFVrVlZlRVI2UVU1Q1owNVdRa0ZuVFVKclNteGpiWGh3WW1wRlVFMUJNRWRCTVZWRlFuZDNSMUZ0Vm5saVIyeDFUVkpKZDBWQldVUldVVkZMUkVGc1IxTldaRUpWYTFWblVUQkZlRVZxUVZGQ1owNVdRa0ZOVFVOVldrcFdNRVpUVWxNeFJGRlVSV05OUW05SFExTnhSMU5KWWpORVVVVktRVkpaVGxreVJrRmFiV3d6V1ZoS2JFeHRPWGxhZWtWTVRVRnJSMEV4VlVWQ1VrMURUVVJGZDJkblNXbE5RVEJIUTFOeFIxTkpZak5FVVVWQ1FWRlZRVUUwU1VORWQwRjNaMmRKUzBGdlNVTkJVVVJJUkZkdldWZGFPVFZXWVRSTVN5dG1VMFJTYmxKclJIbDRVbFZ3TW5aeWJHaE9ObnA1TmpacFRGRTRNbFl5VkVaelVVNUdhMGxDV1RaMEsyaExZMFpxWTB4NFkwZHZaMWM0VkhaTFJrbHlRVTR6WkVKTFNEVmFkVzltVW00eWEyNTRSVlpWUkdSU2VucGhjRzlyVjNOc01UVnpSbmRhZHpWTVYyNUJUbmRMTVU4eGVHUnJlbVZTVTJGS2JIQlVTRGR5VVd0SVJsUkhWMnBzYkdGV1drdHJhM0ZPZDNwUVV6aFljMk5WWWs5eFNtUXhWM0JvTmxoc05IRkhVMk5QT1ZSVWQyUXpORlVyYUcxcVNqSmtVa1EwZGs5dk9UTXpVVlpNZFd4T1EwcE5hWFJhVnpWak1tZExObEU0ZFc5alZtOXBlbGROWlZRNVdsRldZelJwYW5Sd2NsWnplR05MY1Rsa1pDOWxZVFY1VFN0VFlXdzVjazFyTHpCclVERkhNMVp6SzNabVpsTk5hbG9yUkdGSVduZEVlRVZQTUdWWlFXa3ZiRU54YUVobGRtSlFSR1ZGZEZWcFNFSndXa0pYVDBsMVYxUjJWWGw2WlRWNFltUmtRVTQyWTJGWFpFb3pibEZKWVZKWFJqbDVlV2N5VEZKbVJsQndNekpRYldkblYzVkZNVlk1S3psVmVURlNURUk0UlZBeVMwbHJWV3BEU0c1aE9GSktVbEpvVFhGb09FWnhjRWhKZGl0bFQyVXdXbEpEUTBoRlNrUXZZbmQzTW1ONlpFaHlUM05hTW1kWmVIRTFjVTV0YlRSclYwMTNTMEZDV1VrNFdYbERkR3dyWlZOWVdXTkROVVI0Yld4eU9YQmhhVTVLVkhWNFZGZHJVa1YyVUhsak1qSXpNa1J2ZVRoVlJqQnFZV2R5U2xJeWRIaEZVRTgyU2xwVE5uUXpUa1owUnpoRFVGZHhiM3AwYkVGeVQxSkVReXRRUkhKRFRVZEdNbU12VFVwd1JIZHBWMVYyVVRBclZ6ZFZiMjFJYVZGR1ZETk9aWE40V25GdU4xbHVPVkkyWkVobE15dHdia3RUYVVKbFUxaHhhbWxZVHpOeGJVSk5NRU54T1ZweFlYSnNTVlJuVVVaUk5HUTBXakEyUlZnMFVIcFJlV3N3TW5oRlZYWjJWWFJvUjFVMmNETkNaRFZ2ZEVGU2VFWjNVVWxFUVZGQlFtOHhUWGRWVkVGa1FtZE9Wa2hSTkVWR1oxRlZaVUl5YTJwWmR6TnJWMWxQTWtRMGQyMTJZWFZ0YW05U1FrbEZkMGgzV1VSV1VqQnFRa0puZDBadlFWVmxRakpyYWxsM00ydFhXVTh5UkRSM2JYWmhkVzFxYjFKQ1NVVjNSSGRaUkZaU01GUkJVVWd2UWtGVmQwRjNSVUl2ZWtGT1FtZHJjV2hyYVVjNWR6QkNRVkZ6UmtGQlQwTkJaMFZCYWxoaWQzaG9Ta2RWVTBzdlZuTndUbUp3Wmsxck1tUmxlR2RNVTJaeWRteGFSRUZOY2tneVdsY3JXalJoVVUxRWRubGxiV3A2UzBabFQwSkllVVF2UVdZMWFVNU5lbE56YjFwWFlqRXdhRzFHV1ZkdWIwUlBNVVEzWTFaVlFXaE9iWFYxVWtReFpXSkJSa3BST1hKUVdYWjBMemxST0ZCTFJWUjFlREpIZEZGb1NuSllPR1psTjBNeWJuZEdWRmRFVjNoeWIzbFROR1phYWpSelJrVXZhSFpFZUdRemRtNDRNWHBEVTJsaEwyRTVaU3R5V25WclUxaFRUMXBzTVZnemNHNW1WMlJ2VlhWNVNqZ3dkQ3Q1YUdKMGIwWkhSVEpCVmxaVFdHb3JTSGxJVTJ0TFVVZDVTRzFvYTBKVFFtZ3JSa0pLTUZkcFVYQkhjVlpyV0hVelluVkVTMjVVSzJ4RVRVWlFPWFYzTUdSVGREbERTellyVGt0MlQyWm9UMVJVTlRKNVpGaFRMekZ3Ym1oTmNITnNXWFpXVTA5cmVYbEJOVVZWTTNvcmRVNU5TM1p4UlV0TUszQTNWWGR3U1ZZdmIwWllja2RHY2sxM2JUSXdTWFZZUTBOeFNWZ3hhRTB5TmxkWFZsbFdla293YlZSRWEwTnFiRE55VW5CSk9EWjViSGxRYnk5RGVGVjJaekUzU2s1NVdVdHplRWRqYWxwbFZWZFViV0ZOTVZjMVoxb3hOWE5ITDI1elZVZFNOVVZMUVVoNE0yRlBaUzlVUkZsTFZrUnVObWhhTURSQ1REVllNM1pxVUhoYU1qZHlVbkoyYlU0MlMyRkxRVmRrUmtFeE1tRm9jMEU1U1hseFFWTkRkWGw1YWpOVVJVcG9RbFpzVFhkcVpIQjFURXRFWkM4eVNYRjRZMmw0YldSV1VrOVBOVFJRTlZST1oyUkxNRmxZYjBkNE4zSm1XWGxQUXpSNlF6WnhiV3R5YWxscU9GSm5jbmx4VlVkQlQwSjFia0ZqT0hZNWJUUm1OVVZwWkVsWk5WaHFSR2M0T1RsMU5rNWFUbkl2YUdkamMxRnNTVk0wTVVvM2VVTkxOR2hYT0cwMWRYZFZiVTF5ZFU1TmNVRnFiMWRGVGk5UFFYcDZZWGRqTDIxTmEzSlJSa1Z0S3pBMVF5dHNhVFE1WTJoNFkwUnVNM0JFWVhObmJWaEVkVGc5SWwwc0luTnBaMVFpT2lJeU1ESTBMVEEyTFRFeVZERTJPalUyT2pVMFdpSXNJbU55YVhRaU9sc2ljMmxuVkNKZGZRLmV5SnVZbVlpT2pFM01UZ3lNVEUwTVRRc0ltcDBhU0k2SW5WeWJqcDFkV2xrT2pNNFltRXhPREF5TFRabVlqY3ROR1UzWVMwNU5qZGpMVEUyTURNMk9HWTRZV1V5TXlJc0ltbHpjeUk2SW1ScFpEcGxiSE5wT2xaQlZFUkZMVEV5TXpRMU5qY2lMQ0oyWXlJNmV5SjBlWEJsSWpwYklsWmxjbWxtYVdGaWJHVkRjbVZrWlc1MGFXRnNJbDBzSW1semMzVmxjaUk2SW1ScFpEcGxiSE5wT2xaQlZFUkZMVEV5TXpRMU5qY2lMQ0pwYzNOMVlXNWpaVVJoZEdVaU9qRTNNVGd5TVRFME1UUXhOek1zSW1OeVpXUmxiblJwWVd4VGRXSnFaV04wSWpwN0ltWnBjbk4wVG1GdFpTSTZJazFoZUNJc0luSnZiR1Z6SWpwYmV5SnVZVzFsY3lJNld5Sk5lVkp2YkdVaVhTd2lkR0Z5WjJWMElqb2laR2xrT210bGVUb3hJbjFkTENKbVlXMXBiSGxPWVcxbElqb2lUWFZ6ZEdWeWJXRnViaUlzSW1WdFlXbHNJam9pZEdWemRFQjFjMlZ5TG05eVp5SjlMQ0pBWTI5dWRHVjRkQ0k2V3lKb2RIUndjem92TDNkM2R5NTNNeTV2Y21jdk1qQXhPQzlqY21Wa1pXNTBhV0ZzY3k5Mk1TSXNJbWgwZEhCek9pOHZkM2QzTG5jekxtOXlaeTh5TURFNEwyTnlaV1JsYm5ScFlXeHpMMlY0WVcxd2JHVnpMM1l4SWwxOWZR"
const AnyValidSignature = "signature"

var CertChain = []string{
	"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",
}

func (c *mockExternalValidator) ValidateSignature(_ string) (bool, error) {
	return c.signatureValid, nil
}

func TestCheckElsiProof(t *testing.T) {
	type testCase struct {
		testName       string
		headers        jose.Headers
		signatureValid bool
		noError        bool
	}

	CertChainInterface := make([]interface{}, len(CertChain))
	for i, v := range CertChain {
		CertChainInterface[i] = v
	}

	testCases := []testCase{
		{
			testName: "A credential with valid JAdES signature should be successfully validated",
			headers: jose.Headers{
				jose.HeaderKeyID:                SameIssuer,
				jose.HeaderX509CertificateChain: CertChainInterface,
			},
			signatureValid: true,
			noError:        true,
		},
		{
			testName: "A credential with invalid JAdES signature should be rejected",
			headers: jose.Headers{
				jose.HeaderKeyID:                SameIssuer,
				jose.HeaderX509CertificateChain: CertChainInterface,
			},
			signatureValid: false,
			noError:        false,
		},
		{
			testName: "A credential with valid JAdES signature from different issuer should be rejected",
			headers: jose.Headers{
				jose.HeaderKeyID:                OtherIssuer,
				jose.HeaderX509CertificateChain: CertChainInterface,
			},
			signatureValid: true,
			noError:        true,
		},
	}

	externalValidator := &mockExternalValidator{}
	proofChecker := ElsiProofChecker{jAdESValidator: externalValidator}

	msgBytes, err := base64.RawStdEncoding.DecodeString(AnyHeaderAndPayload)
	assert.NoError(t, err)

	for _, tc := range testCases {
		t.Run(tc.testName, func(t *testing.T) {
			logging.Log().Info("TestJadesValidationService_ValidateVC +++++++ Running test: ", tc.testName)
			externalValidator.signatureValid = tc.signatureValid

			err := proofChecker.checkElsiProof(tc.headers, SameIssuer, msgBytes, []byte(AnyValidSignature))

			if tc.noError {
				assert.NoError(t, err)
			} else {
				assert.Error(t, err)
			}
		})
	}
}
